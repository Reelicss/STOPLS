
local IsStudio = false

local ContextActionService = game:GetService("ContextActionService")
local HttpService = game:GetService("HttpService")
local GuiService = game:GetService("GuiService")
local CoreGui = game:GetService("CoreGui")
local AvatarEditorService = game:GetService("AvatarEditorService")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Emotes = {}
local CustomEmoteOrder = {}
local DraggingEmote = nil
local FavoritesVisible = true
local AvatarSwitchKeybind = Enum.KeyCode.G
local CloseAfterEmote = false

local function AddEmote(name, id, price)
	if not (name and id) then return end
	table.insert(Emotes, {
		["name"] = name,
		["id"] = id,
		["icon"] = "rbxthumb://type=Asset&id=".. id .."&w=150&h=150",
		["price"] = price or 0,
		["index"] = #Emotes + 1,
		["sort"] = {},
		["customOrder"] = nil
	})
end

local CurrentSort = "newestfirst"
local FavoriteOff = "rbxassetid://10651060677"
local FavoriteOn = "rbxassetid://10651061109"
local FavoritedEmotes = {}
local CustomEmotes = {}

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Emotes"
ScreenGui.DisplayOrder = 1
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false
ScreenGui.Enabled = false

local BackFrame = Instance.new("Frame")
BackFrame.Size = UDim2.new(1.3, 0, 0.9, 0.3)
BackFrame.AnchorPoint = Vector2.new(0.5, 0.5)
BackFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
BackFrame.SizeConstraint = Enum.SizeConstraint.RelativeYY
BackFrame.BackgroundTransparency = 1
BackFrame.BorderSizePixel = 0
BackFrame.Parent = ScreenGui

local EmoteName = Instance.new("TextLabel")
EmoteName.Name = "EmoteName"
EmoteName.TextScaled = true
EmoteName.AnchorPoint = Vector2.new(0.5, 0.5)
EmoteName.Position = UDim2.new(-0.02, 0, 0.5, 0)
EmoteName.Size = UDim2.new(0.12, 0, 0.05, 0)
EmoteName.SizeConstraint = Enum.SizeConstraint.RelativeYY
EmoteName.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
EmoteName.BackgroundTransparency = 0.3
EmoteName.TextColor3 = Color3.new(1, 1, 1)
EmoteName.BorderSizePixel = 0
EmoteName.Font = Enum.Font.GothamBold
EmoteName.Parent = BackFrame

local Corner = Instance.new("UICorner")
Corner.Parent = EmoteName

local EmoteNameStroke = Instance.new("UIStroke")
EmoteNameStroke.Color = Color3.fromRGB(80, 80, 80)
EmoteNameStroke.Thickness = 1
EmoteNameStroke.Transparency = 0.5
EmoteNameStroke.Parent = EmoteName

local Loading = Instance.new("TextLabel", BackFrame)
Loading.AnchorPoint = Vector2.new(0.5, 0.5)
Loading.Text = "Loading Emote Wheel."
Loading.TextColor3 = Color3.new(1, 1, 1)
Loading.BackgroundColor3 = Color3.new(0, 0, 0)
Loading.TextScaled = true
Loading.BackgroundTransparency = 0.5
Loading.Size = UDim2.fromScale(0.2, 0.1)
Loading.Position = UDim2.fromScale(0.5, 0.2)
Loading.Font = Enum.Font.GothamBold
Corner:Clone().Parent = Loading

local Frame = Instance.new("ScrollingFrame")
Frame.Size = UDim2.new(0.8, 3, 1.2, 1)
Frame.CanvasSize = UDim2.new(0, 0, 0, 0)
Frame.AutomaticCanvasSize = Enum.AutomaticSize.Y
Frame.ScrollingDirection = Enum.ScrollingDirection.Y
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.Position = UDim2.new(0.5, 0, 0.5, 1)
Frame.BackgroundTransparency = 1
Frame.ScrollBarThickness = 0
Frame.BorderSizePixel = 0
Frame.MouseLeave:Connect(function()
	EmoteName.Text = "Select an Emote"
end)
Frame.Parent = BackFrame

local Grid = Instance.new("UIGridLayout")
Grid.CellSize = UDim2.new(0.105, 0, 0.105, 0)
Grid.CellPadding = UDim2.new(0.005, 0, 0.002, 0)
Grid.SortOrder = Enum.SortOrder.LayoutOrder
Grid.Parent = Frame

local CustomEmoteFrame = Instance.new("Frame")
CustomEmoteFrame.Visible = false
CustomEmoteFrame.BorderSizePixel = 0
CustomEmoteFrame.AnchorPoint = Vector2.new(0.5, 0.5)
CustomEmoteFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
CustomEmoteFrame.Size = UDim2.new(0.3, 0, 0.45, 0)
CustomEmoteFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
CustomEmoteFrame.BackgroundTransparency = 0.1
CustomEmoteFrame.ZIndex = 10
Corner:Clone().Parent = CustomEmoteFrame
CustomEmoteFrame.Parent = BackFrame

local CustomFrameStroke = Instance.new("UIStroke")
CustomFrameStroke.Color = Color3.fromRGB(80, 80, 80)
CustomFrameStroke.Thickness = 1
CustomFrameStroke.Transparency = 0.5
CustomFrameStroke.Parent = CustomEmoteFrame

local CustomEmoteTitle = Instance.new("TextLabel")
CustomEmoteTitle.Text = "Add Emote"
CustomEmoteTitle.TextScaled = true
CustomEmoteTitle.BackgroundTransparency = 1
CustomEmoteTitle.TextColor3 = Color3.new(1, 1, 1)
CustomEmoteTitle.Size = UDim2.new(1, 0, 0.12, 0)
CustomEmoteTitle.Position = UDim2.new(0, 0, 0.02, 0)
CustomEmoteTitle.ZIndex = 11
CustomEmoteTitle.Font = Enum.Font.GothamBold
CustomEmoteTitle.Parent = CustomEmoteFrame

local CustomEmoteNameBox = Instance.new("TextBox")
CustomEmoteNameBox.PlaceholderText = "Emote Name"
CustomEmoteNameBox.Text = ""
CustomEmoteNameBox.TextScaled = true
CustomEmoteNameBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
CustomEmoteNameBox.TextColor3 = Color3.new(1, 1, 1)
CustomEmoteNameBox.Size = UDim2.new(0.8, 0, 0.12, 0)
CustomEmoteNameBox.Position = UDim2.new(0.1, 0, 0.18, 0)
CustomEmoteNameBox.BorderSizePixel = 0
CustomEmoteNameBox.ZIndex = 11
Corner:Clone().Parent = CustomEmoteNameBox
CustomEmoteNameBox.Parent = CustomEmoteFrame

local CustomEmoteIDBox = Instance.new("TextBox")
CustomEmoteIDBox.PlaceholderText = "Emote ID"
CustomEmoteIDBox.Text = ""
CustomEmoteIDBox.TextScaled = true
CustomEmoteIDBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
CustomEmoteIDBox.TextColor3 = Color3.new(1, 1, 1)
CustomEmoteIDBox.Size = UDim2.new(0.8, 0, 0.12, 0)
CustomEmoteIDBox.Position = UDim2.new(0.1, 0, 0.34, 0)
CustomEmoteIDBox.BorderSizePixel = 0
CustomEmoteIDBox.ZIndex = 11
Corner:Clone().Parent = CustomEmoteIDBox
CustomEmoteIDBox.Parent = CustomEmoteFrame

local CustomEmoteOrderBox = Instance.new("TextBox")
CustomEmoteOrderBox.PlaceholderText = "Order Number (Optional)"
CustomEmoteOrderBox.Text = ""
CustomEmoteOrderBox.TextScaled = true
CustomEmoteOrderBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
CustomEmoteOrderBox.TextColor3 = Color3.new(1, 1, 1)
CustomEmoteOrderBox.Size = UDim2.new(0.8, 0, 0.12, 0)
CustomEmoteOrderBox.Position = UDim2.new(0.1, 0, 0.50, 0)
CustomEmoteOrderBox.BorderSizePixel = 0
CustomEmoteOrderBox.ZIndex = 11
Corner:Clone().Parent = CustomEmoteOrderBox
CustomEmoteOrderBox.Parent = CustomEmoteFrame

local AddCustomEmoteButton = Instance.new("TextButton")
AddCustomEmoteButton.Text = "Add"
AddCustomEmoteButton.TextScaled = true
AddCustomEmoteButton.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
AddCustomEmoteButton.TextColor3 = Color3.new(1, 1, 1)
AddCustomEmoteButton.Size = UDim2.new(0.35, 0, 0.12, 0)
AddCustomEmoteButton.Position = UDim2.new(0.1, 0, 0.68, 0)
AddCustomEmoteButton.BorderSizePixel = 0
AddCustomEmoteButton.ZIndex = 11
AddCustomEmoteButton.Font = Enum.Font.GothamBold
Corner:Clone().Parent = AddCustomEmoteButton
AddCustomEmoteButton.Parent = CustomEmoteFrame

local CloseCustomEmoteButton = Instance.new("TextButton")
CloseCustomEmoteButton.Text = "Close"
CloseCustomEmoteButton.TextScaled = true
CloseCustomEmoteButton.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
CloseCustomEmoteButton.TextColor3 = Color3.new(1, 1, 1)
CloseCustomEmoteButton.Size = UDim2.new(0.35, 0, 0.12, 0)
CloseCustomEmoteButton.Position = UDim2.new(0.55, 0, 0.68, 0)
CloseCustomEmoteButton.BorderSizePixel = 0
CloseCustomEmoteButton.ZIndex = 11
CloseCustomEmoteButton.Font = Enum.Font.GothamBold
Corner:Clone().Parent = CloseCustomEmoteButton
CloseCustomEmoteButton.Parent = CustomEmoteFrame

CloseCustomEmoteButton.MouseButton1Click:Connect(function()
	CustomEmoteFrame.Visible = false
end)

local SortFrame = Instance.new("Frame")
SortFrame.Visible = false
SortFrame.BorderSizePixel = 0
SortFrame.Position = UDim2.new(1, 5, -0.125, 0)
SortFrame.Size = UDim2.new(0.7, 0, 0, 0)
SortFrame.AutomaticSize = Enum.AutomaticSize.Y
SortFrame.BackgroundTransparency = 0.9
Corner:Clone().Parent = SortFrame
SortFrame.Parent = BackFrame

local SortList = Instance.new("UIListLayout")
SortList.Padding = UDim.new(0.07, 1)
SortList.HorizontalAlignment = Enum.HorizontalAlignment.Center
SortList.VerticalAlignment = Enum.VerticalAlignment.Top
SortList.SortOrder = Enum.SortOrder.LayoutOrder
SortList.Parent = SortFrame

local function IsFileFunc(...)
	if IsStudio then return end
	if isfile then return isfile(...) end
end

local function WriteFileFunc(...)
	if IsStudio then return end
	if writefile then return writefile(...) end
end

local function ReadFileFunc(...)
	if IsStudio then return end
	if readfile then return readfile(...) end
end

local function SendNotification(title, text)
	if (not IsStudio) and syn and syn.toast_notification then
		syn.toast_notification({
			Type = ToastType.Error,
			Title = title,
			Content = text
		})
	else
		StarterGui:SetCore("SendNotification", {
			Title = title,
			Text = text
		})
	end
end

local function SortEmotes()
	for i, Emote in pairs(Emotes) do
		local EmoteButton = Frame:FindFirstChild(tostring(Emote.id))
		if not EmoteButton then continue end
		local IsFavorited = table.find(FavoritedEmotes, Emote.id)
		if Emote.customOrder then
			EmoteButton.LayoutOrder = Emote.customOrder
		else
			EmoteButton.LayoutOrder = Emote.sort[CurrentSort] + ((IsFavorited and 55) or #Emotes)
		end
		local numberLabel = EmoteButton:FindFirstChild("number")
		if numberLabel then
			numberLabel.Text = Emote.sort[CurrentSort]
		end
	end
end

local function createsort(order, text, sort)
	local CreatedSort = Instance.new("TextButton")
	CreatedSort.SizeConstraint = Enum.SizeConstraint.RelativeXX
	CreatedSort.Size = UDim2.new(1, 0, 0.2, 0)
	CreatedSort.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	CreatedSort.LayoutOrder = order
	CreatedSort.TextColor3 = Color3.new(1, 1, 1)
	CreatedSort.Text = text
	CreatedSort.TextScaled = true
	CreatedSort.BorderSizePixel = 0
	CreatedSort.Font = Enum.Font.GothamBold
	Corner:Clone().Parent = CreatedSort
	CreatedSort.Parent = SortFrame
	CreatedSort.MouseButton1Click:Connect(function()
		SortFrame.Visible = false
		CurrentSort = sort
		SortEmotes()
	end)
	return CreatedSort
end

createsort(1, "Newest First", "newestfirst")
createsort(2, "Oldest First", "oldestfirst")
createsort(3, "Alphabetically First", "alphabeticfirst")
createsort(4, "Alphabetically Last", "alphabeticlast")
createsort(5, "Highest Price", "highestprice")
createsort(6, "Lowest Price", "lowestprice")

local SortButton = Instance.new("TextButton")
SortButton.BorderSizePixel = 0
SortButton.AnchorPoint = Vector2.new(0.5, 0.5)
SortButton.Position = UDim2.new(1, -10, -5, 0)
SortButton.Size = UDim2.new(0.08, 0, 0.04, 0)
SortButton.TextScaled = true
SortButton.TextColor3 = Color3.new(1, 1, 1)
SortButton.BackgroundColor3 = Color3.new(0, 0, 0)
SortButton.BackgroundTransparency = 1
SortButton.Text = "Sort"
SortButton.Font = Enum.Font.GothamBold
SortButton.MouseButton1Click:Connect(function()
	SortFrame.Visible = not SortFrame.Visible
end)
Corner:Clone().Parent = SortButton
SortButton.Parent = BackFrame

local AvatarSwitchButton = Instance.new("TextButton")
AvatarSwitchButton.BorderSizePixel = 0
AvatarSwitchButton.AnchorPoint = Vector2.new(0.5, 0.5)
AvatarSwitchButton.Position = UDim2.new(0.95, 0, 0.5, 0)
AvatarSwitchButton.Size = UDim2.new(0.1, 0, 0.04, 0)
AvatarSwitchButton.TextScaled = true
AvatarSwitchButton.TextColor3 = Color3.new(1, 1, 1)
AvatarSwitchButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
AvatarSwitchButton.BackgroundTransparency = 0.3
AvatarSwitchButton.Text = "Avatar Switch"
AvatarSwitchButton.Font = Enum.Font.GothamBold
Corner:Clone().Parent = AvatarSwitchButton
AvatarSwitchButton.Parent = BackFrame

local AvatarStroke = Instance.new("UIStroke")
AvatarStroke.Color = Color3.fromRGB(80, 80, 80)
AvatarStroke.Thickness = 1
AvatarStroke.Transparency = 0.5
AvatarStroke.Parent = AvatarSwitchButton

local KeybindButton = Instance.new("TextButton")
KeybindButton.BorderSizePixel = 0
KeybindButton.AnchorPoint = Vector2.new(0.5, 0.5)
KeybindButton.Position = UDim2.new(0.95, 0, 0.535, 0)
KeybindButton.Size = UDim2.new(0.04, 0, 0.025, 0)
KeybindButton.TextScaled = true
KeybindButton.TextColor3 = Color3.new(1, 1, 1)
KeybindButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
KeybindButton.BackgroundTransparency = 0.3
KeybindButton.Text = "G"
KeybindButton.Font = Enum.Font.GothamBold
Corner:Clone().Parent = KeybindButton
KeybindButton.Parent = BackFrame

local KeybindStroke = Instance.new("UIStroke")
KeybindStroke.Color = Color3.fromRGB(80, 80, 80)
KeybindStroke.Thickness = 1
KeybindStroke.Transparency = 0.5
KeybindStroke.Parent = KeybindButton

local AutoCloseButton = Instance.new("TextButton")
AutoCloseButton.BorderSizePixel = 0
AutoCloseButton.AnchorPoint = Vector2.new(0.5, 0.5)
AutoCloseButton.Position = UDim2.new(0.95, 0, 0.58, 0)
AutoCloseButton.Size = UDim2.new(0.1, 0, 0.03, 0)
AutoCloseButton.TextScaled = true
AutoCloseButton.TextColor3 = Color3.new(1, 1, 1)
AutoCloseButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
AutoCloseButton.BackgroundTransparency = 0.3
AutoCloseButton.Text = "Auto Close: OFF"
AutoCloseButton.Font = Enum.Font.GothamBold
Corner:Clone().Parent = AutoCloseButton
AutoCloseButton.Parent = BackFrame

local AutoCloseStroke = Instance.new("UIStroke")
AutoCloseStroke.Color = Color3.fromRGB(80, 80, 80)
AutoCloseStroke.Thickness = 1
AutoCloseStroke.Transparency = 0.5
AutoCloseStroke.Parent = AutoCloseButton

AutoCloseButton.MouseButton1Click:Connect(function()
	CloseAfterEmote = not CloseAfterEmote
	AutoCloseButton.Text = CloseAfterEmote and "Auto Close: ON" or "Auto Close: OFF"
	WriteFileFunc("AutoCloseEmote.txt", HttpService:JSONEncode({enabled = CloseAfterEmote}))
	SendNotification("Auto Close", CloseAfterEmote and "UI will close after each emote" or "UI will stay open after emotes")
end)

local AwaitingKeybind = false

local function FireAvatarSwitch()
	local refreshEvent = ReplicatedStorage:FindFirstChild("event_modify_refresh")
	if refreshEvent then
		refreshEvent:FireServer(Players.LocalPlayer)
		SendNotification("Avatar Switch", "Avatar refreshed!")
	else
		SendNotification("Error", "Refresh event not found!")
	end
end

AvatarSwitchButton.MouseButton1Click:Connect(FireAvatarSwitch)

KeybindButton.MouseButton1Click:Connect(function()
	AwaitingKeybind = true
	KeybindButton.Text = "..."
	KeybindButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
end)

local SearchBar = Instance.new("TextBox")
SearchBar.BorderSizePixel = 0
SearchBar.AnchorPoint = Vector2.new(0.5, 0.5)
SearchBar.Position = UDim2.new(1, 0, -0.055, 0)
SearchBar.Size = UDim2.new(0.1, 0, 0.04, 0)
SearchBar.TextScaled = true
SearchBar.PlaceholderText = "Search"
SearchBar.TextColor3 = Color3.new(1, 1, 1)
SearchBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SearchBar.BackgroundTransparency = 0.3
SearchBar:GetPropertyChangedSignal("Text"):Connect(function()
	local text = SearchBar.Text:lower():sub(1, 50)
	if SearchBar.Text ~= text then SearchBar.Text = text end
	for _, button in pairs(Frame:GetChildren()) do
		if button:IsA("GuiButton") then
			local name = button:GetAttribute("name")
			if name then
				button.Visible = text == "" or name:lower():match(text)
			end
		end
	end
end)
Corner:Clone().Parent = SearchBar
SearchBar.Parent = BackFrame

local SearchStroke = Instance.new("UIStroke")
SearchStroke.Color = Color3.fromRGB(80, 80, 80)
SearchStroke.Thickness = 1
SearchStroke.Transparency = 0.5
SearchStroke.Parent = SearchBar

local AddEmoteButton = Instance.new("TextButton")
AddEmoteButton.BorderSizePixel = 0
AddEmoteButton.AnchorPoint = Vector2.new(0.5, 0.5)
AddEmoteButton.Position = UDim2.new(1, 0, 0, 0)
AddEmoteButton.Size = UDim2.new(0.1, 0, 0.04, 0)
AddEmoteButton.TextScaled = true
AddEmoteButton.TextColor3 = Color3.new(1, 1, 1)
AddEmoteButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
AddEmoteButton.BackgroundTransparency = 0.3
AddEmoteButton.Text = "Add Emote"
AddEmoteButton.Font = Enum.Font.GothamBold
AddEmoteButton.MouseButton1Click:Connect(function()
	CustomEmoteFrame.Visible = not CustomEmoteFrame.Visible
end)
Corner:Clone().Parent = AddEmoteButton
AddEmoteButton.Parent = BackFrame

local AddEmoteStroke = Instance.new("UIStroke")
AddEmoteStroke.Color = Color3.fromRGB(80, 80, 80)
AddEmoteStroke.Thickness = 1
AddEmoteStroke.Transparency = 0.5
AddEmoteStroke.Parent = AddEmoteButton

local MadeByLabel = Instance.new("TextLabel")
MadeByLabel.Text = "Made By Za1k.                  Version: 2.6.7 ðŸ¥´"
MadeByLabel.TextScaled = true
MadeByLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
MadeByLabel.BackgroundTransparency = 0.3
MadeByLabel.TextColor3 = Color3.new(1, 1, 1)
MadeByLabel.BorderSizePixel = 0
MadeByLabel.AnchorPoint = Vector2.new(0.5, 0.5)
MadeByLabel.Position = UDim2.new(1.02, 0, 1, 0)
MadeByLabel.Size = UDim2.new(0.25, 0, 0.06, 0)
MadeByLabel.Font = Enum.Font.GothamBold
Corner:Clone().Parent = MadeByLabel
MadeByLabel.Parent = BackFrame

local function openemotes(name, state, input)
	if state == Enum.UserInputState.Begin then
		ScreenGui.Enabled = not ScreenGui.Enabled
	end
end

if IsStudio then
	ContextActionService:BindActionAtPriority("Emote Menu", openemotes, true, 2001, Enum.KeyCode.Comma)
else
	ContextActionService:BindCoreActionAtPriority("Emote Menu", openemotes, true, 2001, Enum.KeyCode.Comma)
end

local inputconnect
ScreenGui:GetPropertyChangedSignal("Enabled"):Connect(function()
	if ScreenGui.Enabled then
		EmoteName.Text = "Select an Emote"
		SearchBar.Text = ""
		SortFrame.Visible = false
		GuiService:SetEmotesMenuOpen(false)
		inputconnect = UserInputService.InputBegan:Connect(function(input, processed)
			if not processed and input.UserInputType == Enum.UserInputType.MouseButton1 then
				ScreenGui.Enabled = false
			end
		end)
	elseif inputconnect then
		inputconnect:Disconnect()
	end
end)

if not IsStudio then
	GuiService.EmotesMenuOpenChanged:Connect(function(isopen)
		if isopen then ScreenGui.Enabled = false end
	end)
end

GuiService.MenuOpened:Connect(function()
	ScreenGui.Enabled = false
end)

if not game:IsLoaded() then game.Loaded:Wait() end

local LocalPlayer = Players.LocalPlayer

if IsStudio then
	ScreenGui.Parent = LocalPlayer.PlayerGui
else
	local SynV3 = syn and DrawingImmediate
	if (not is_sirhurt_closure) and (not SynV3) and (syn and syn.protect_gui) then
		syn.protect_gui(ScreenGui)
		ScreenGui.Parent = CoreGui
	elseif get_hidden_gui or gethui then
		ScreenGui.Parent = (get_hidden_gui or gethui)()
	else
		ScreenGui.Parent = CoreGui
	end
end

local function HumanoidPlayEmote(humanoid, name, id)
	if IsStudio then
		return humanoid:PlayEmote(name)
	else
		return humanoid:PlayEmoteAndGetAnimTrackById(id)
	end
end

local function PlayEmote(name, id)
	SearchBar.Text = ""
	local Humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
	local Description = Humanoid and Humanoid:FindFirstChildOfClass("HumanoidDescription")
	if not Description then return end
	if LocalPlayer.Character.Humanoid.RigType ~= Enum.HumanoidRigType.R6 then
		local succ = pcall(function() HumanoidPlayEmote(Humanoid, name, id) end)
		if not succ then
			Description:AddEmote(name, id)
			HumanoidPlayEmote(Humanoid, name, id)
		end
		if CloseAfterEmote then
			ScreenGui.Enabled = false
		end
	else
		SendNotification("r6? lol", "you gotta be r15 dude")
	end
end

local function WaitForChildOfClass(parent, class)
	local child = parent:FindFirstChildOfClass(class)
	while not child or child.ClassName ~= class do
		child = parent.ChildAdded:Wait()
	end
	return child
end

local params = CatalogSearchParams.new()
params.AssetTypes = {Enum.AvatarAssetType.EmoteAnimation}
params.SortType = Enum.CatalogSortType.RecentlyCreated
params.SortAggregation = Enum.CatalogSortAggregation.AllTime
params.IncludeOffSale = true
params.CreatorName = "Roblox"
params.Limit = 120

local function getCatalogPage()
	local success, catalogPage = pcall(function()
		return AvatarEditorService:SearchCatalog(params)
	end)
	if not success then
		task.wait(5)
		return getCatalogPage()
	end
	return catalogPage
end

local catalogPage = getCatalogPage()
local pages = {}

while true do
	table.insert(pages, catalogPage:GetCurrentPage())
	if catalogPage.IsFinished then break end
	local function AdvanceToNextPage()
		local success = pcall(function() catalogPage:AdvanceToNextPageAsync() end)
		if not success then
			task.wait(5)
			return AdvanceToNextPage()
		end
	end
	AdvanceToNextPage()
end

for _, page in pairs(pages) do
	for _, emote in pairs(page) do
		AddEmote(emote.Name, emote.Id, emote.Price)
	end
end

AddEmote("Sitting", 139621472081340)
AddEmote("Naked", 15571538346)
AddEmote("Huego Drive", 17360720445)
AddEmote("Hand Stand", 124055618254120)
AddEmote("dead", 119400441490983)
AddEmote("patty cake2", 76124649545220)
AddEmote("patty cake", 120642514156293)
AddEmote("Ghostly", 124071723800586)
AddEmote("Roll", 130726889233022)
AddEmote("Angles", 75837489916720)
AddEmote("Oof", 110740075367686)
AddEmote("imagination", 18443268949)
AddEmote("abcd", 129297813295515)
AddEmote("Side Stepper", 14024722653)
AddEmote("Around", 16215060261)
AddEmote("low", 10214411646)
AddEmote("talking", 6303091119)
AddEmote("talking", 134615135651900)
AddEmote("twicee", 14900153406)
AddEmote("archer", 13823339506)
AddEmote("egirl", 117809429848082)
AddEmote("sab", 80652345815019)
AddEmote("fashion", 73683655527605)

Loading:Destroy()

table.sort(Emotes, function(a, b) return a.index < b.index end)
for i, v in pairs(Emotes) do v.sort.newestfirst = i end

table.sort(Emotes, function(a, b) return a.index > b.index end)
for i, v in pairs(Emotes) do v.sort.oldestfirst = i end

table.sort(Emotes, function(a, b) return a.name:lower() < b.name:lower() end)
for i, v in pairs(Emotes) do v.sort.alphabeticfirst = i end

table.sort(Emotes, function(a, b) return a.name:lower() > b.name:lower() end)
for i, v in pairs(Emotes) do v.sort.alphabeticlast = i end

table.sort(Emotes, function(a, b) return a.price < b.price end)
for i, v in pairs(Emotes) do v.sort.lowestprice = i end

table.sort(Emotes, function(a, b) return a.price > b.price end)
for i, v in pairs(Emotes) do v.sort.highestprice = i end

if not IsStudio then
	if IsFileFunc("FavoritedEmotes.txt") then
		pcall(function() FavoritedEmotes = HttpService:JSONDecode(ReadFileFunc("FavoritedEmotes.txt")) end)
	else
		WriteFileFunc("FavoritedEmotes.txt", HttpService:JSONEncode(FavoritedEmotes))
	end
	
	if IsFileFunc("CustomEmotes.txt") then
		pcall(function()
			CustomEmotes = HttpService:JSONDecode(ReadFileFunc("CustomEmotes.txt"))
			for _, customEmote in pairs(CustomEmotes) do
				AddEmote(customEmote.name, customEmote.id, 0)
				if customEmote.order then
					Emotes[#Emotes].customOrder = customEmote.order
				end
			end
		end)
	else
		WriteFileFunc("CustomEmotes.txt", HttpService:JSONEncode(CustomEmotes))
	end
	
	if IsFileFunc("CustomEmoteOrder.txt") then
		pcall(function() CustomEmoteOrder = HttpService:JSONDecode(ReadFileFunc("CustomEmoteOrder.txt")) end)
	else
		WriteFileFunc("CustomEmoteOrder.txt", HttpService:JSONEncode(CustomEmoteOrder))
	end
	
	if IsFileFunc("FavoritesVisible.txt") then
		pcall(function()
			local data = HttpService:JSONDecode(ReadFileFunc("FavoritesVisible.txt"))
			FavoritesVisible = data.visible
		end)
	else
		WriteFileFunc("FavoritesVisible.txt", HttpService:JSONEncode({visible = FavoritesVisible}))
	end
	
	if IsFileFunc("AvatarSwitchKeybind.txt") then
		pcall(function()
			local data = HttpService:JSONDecode(ReadFileFunc("AvatarSwitchKeybind.txt"))
			AvatarSwitchKeybind = Enum.KeyCode[data.keybind] or Enum.KeyCode.G
			KeybindButton.Text = AvatarSwitchKeybind.Name
		end)
	else
		WriteFileFunc("AvatarSwitchKeybind.txt", HttpService:JSONEncode({keybind = "G"}))
	end
	
	if IsFileFunc("AutoCloseEmote.txt") then
		pcall(function()
			local data = HttpService:JSONDecode(ReadFileFunc("AutoCloseEmote.txt"))
			CloseAfterEmote = data.enabled
			AutoCloseButton.Text = CloseAfterEmote and "Auto Close: ON" or "Auto Close: OFF"
		end)
	else
		WriteFileFunc("AutoCloseEmote.txt", HttpService:JSONEncode({enabled = CloseAfterEmote}))
	end
end

UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if AwaitingKeybind and input.UserInputType == Enum.UserInputType.Keyboard then
		AvatarSwitchKeybind = input.KeyCode
		KeybindButton.Text = input.KeyCode.Name
		KeybindButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
		AwaitingKeybind = false
		WriteFileFunc("AvatarSwitchKeybind.txt", HttpService:JSONEncode({keybind = input.KeyCode.Name}))
		SendNotification("Keybind Set", "Avatar Switch keybind set to " .. input.KeyCode.Name)
		return
	end
	if input.KeyCode == AvatarSwitchKeybind then
		FireAvatarSwitch()
	end
end)

local function ToggleFavoriteButtons()
	FavoritesVisible = not FavoritesVisible
	for _, emoteButton in pairs(Frame:GetChildren()) do
		if emoteButton:IsA("GuiButton") then
			local fav = emoteButton:FindFirstChild("favorite")
			if fav then fav.Visible = FavoritesVisible end
		end
	end
	local toggleBtn = Frame:FindFirstChild("HideFavoritesBtn")
	if toggleBtn then
		toggleBtn.Text = FavoritesVisible and "Hide Favorites" or "Show Favorites"
	end
	WriteFileFunc("FavoritesVisible.txt", HttpService:JSONEncode({visible = FavoritesVisible}))
	SendNotification("Favorites Toggle", "Favorite buttons are now " .. (FavoritesVisible and "shown" or "hidden"))
end

local function CreateEmoteButton(Emote, Description, Ratio)
	Description:AddEmote(Emote.name, Emote.id)
	local EmoteButton = Instance.new("ImageButton")
	local IsFavorited = table.find(FavoritedEmotes, Emote.id)
	
	if CustomEmoteOrder[tostring(Emote.id)] then
		Emote.customOrder = CustomEmoteOrder[tostring(Emote.id)]
		EmoteButton.LayoutOrder = Emote.customOrder
	elseif Emote.customOrder then
		EmoteButton.LayoutOrder = Emote.customOrder
	else
		EmoteButton.LayoutOrder = Emote.sort[CurrentSort] + ((IsFavorited and 0) or #Emotes)
	end
	
	EmoteButton.Name = tostring(Emote.id)
	EmoteButton:SetAttribute("name", Emote.name)
	Corner:Clone().Parent = EmoteButton
	EmoteButton.Image = Emote.icon
	EmoteButton.BackgroundTransparency = 0.5
	EmoteButton.BackgroundColor3 = Color3.new(0, 0, 0)
	EmoteButton.BorderSizePixel = 0
	Ratio:Clone().Parent = EmoteButton
	
	local ButtonStroke = Instance.new("UIStroke")
	ButtonStroke.Color = Color3.fromRGB(80, 80, 80)
	ButtonStroke.Thickness = 1
	ButtonStroke.Transparency = 0.5
	ButtonStroke.Parent = EmoteButton
	
	local EmoteNumber = Instance.new("TextLabel")
	EmoteNumber.Name = "number"
	EmoteNumber.TextScaled = true
	EmoteNumber.BackgroundTransparency = 1
	EmoteNumber.TextColor3 = Color3.new(1, 1, 1)
	EmoteNumber.BorderSizePixel = 0
	EmoteNumber.AnchorPoint = Vector2.new(0.5, 0.5)
	EmoteNumber.Size = UDim2.new(0.2, 0, 0.2, 0)
	EmoteNumber.Position = UDim2.new(0.1, 0, 0.9, 0)
	EmoteNumber.Text = tostring(Emote.sort[CurrentSort] or "")
	EmoteNumber.TextXAlignment = Enum.TextXAlignment.Center
	EmoteNumber.TextYAlignment = Enum.TextYAlignment.Center
	EmoteNumber.Font = Enum.Font.GothamBold
	local UIStroke = Instance.new("UIStroke")
	UIStroke.Transparency = 0.5
	UIStroke.Parent = EmoteNumber
	EmoteNumber.Parent = EmoteButton
	EmoteButton.Parent = Frame
	
	EmoteButton.MouseButton1Click:Connect(function()
		if not DraggingEmote then
			PlayEmote(Emote.name, Emote.id)
		else
			local dragOrder = DraggingEmote.button.LayoutOrder
			local targetOrder = EmoteButton.LayoutOrder
			DraggingEmote.button.LayoutOrder = targetOrder
			EmoteButton.LayoutOrder = dragOrder
			for _, e in pairs(Emotes) do
				if e.id == DraggingEmote.id then
					e.customOrder = targetOrder
				elseif e.id == Emote.id then
					e.customOrder = dragOrder
				end
			end
			local orderData = {}
			for _, e in pairs(Emotes) do
				if e.customOrder then orderData[tostring(e.id)] = e.customOrder end
			end
			WriteFileFunc("CustomEmoteOrder.txt", HttpService:JSONEncode(orderData))
			SendNotification("Emotes Swapped", "Position saved!")
			DraggingEmote.button.BackgroundColor3 = Color3.new(0, 0, 0)
			DraggingEmote.button.BackgroundTransparency = 0.5
			DraggingEmote = nil
		end
	end)
	
	EmoteButton.MouseButton2Down:Connect(function()
		DraggingEmote = {button = EmoteButton, id = Emote.id, originalOrder = EmoteButton.LayoutOrder}
		EmoteButton.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
		EmoteButton.BackgroundTransparency = 0.2
	end)
	
	EmoteButton.MouseButton2Up:Connect(function()
		task.wait(0.1)
		if DraggingEmote then
			DraggingEmote.button.BackgroundColor3 = Color3.new(0, 0, 0)
			DraggingEmote.button.BackgroundTransparency = 0.5
			DraggingEmote = nil
		end
	end)
	
	EmoteButton.MouseEnter:Connect(function()
		EmoteName.Text = Emote.name
		if DraggingEmote and DraggingEmote.id ~= Emote.id then
			EmoteButton.BackgroundColor3 = Color3.fromRGB(255, 255, 100)
			EmoteButton.BackgroundTransparency = 0.2
		end
	end)
	
	EmoteButton.MouseLeave:Connect(function()
		if not DraggingEmote or DraggingEmote.id ~= Emote.id then
			EmoteButton.BackgroundColor3 = Color3.new(0, 0, 0)
			EmoteButton.BackgroundTransparency = 0.5
		end
	end)
	
	local Favorite = Instance.new("ImageButton")
	Favorite.Name = "favorite"
	Favorite.Image = table.find(FavoritedEmotes, Emote.id) and FavoriteOn or FavoriteOff
	Favorite.AnchorPoint = Vector2.new(0.5, 0.5)
	Favorite.Size = UDim2.new(0.1, 0, 0.1, 0)
	Favorite.Position = UDim2.new(0.9, 0, 0.9, 0)
	Favorite.BorderSizePixel = 0
	Favorite.BackgroundTransparency = 1
	Favorite.Visible = FavoritesVisible
	Favorite.Parent = EmoteButton
	Favorite.MouseButton1Click:Connect(function()
		local index = table.find(FavoritedEmotes, Emote.id)
		if index then
			table.remove(FavoritedEmotes, index)
			Favorite.Image = FavoriteOff
			EmoteButton.LayoutOrder = Emote.sort[CurrentSort] + #Emotes
		else
			table.insert(FavoritedEmotes, Emote.id)
			Favorite.Image = FavoriteOn
			EmoteButton.LayoutOrder = Emote.sort[CurrentSort]
		end
		WriteFileFunc("FavoritedEmotes.txt", HttpService:JSONEncode(FavoritedEmotes))
	end)
	
	return EmoteButton
end

AddCustomEmoteButton.MouseButton1Click:Connect(function()
	local emoteName = CustomEmoteNameBox.Text
	local emoteID = tonumber(CustomEmoteIDBox.Text)
	local emoteOrder = tonumber(CustomEmoteOrderBox.Text)
	
	if emoteName ~= "" and emoteID then
		local exists = false
		for _, emote in pairs(Emotes) do
			if emote.id == emoteID then
				exists = true
				break
			end
		end
		
		if not exists then
			local customEmoteData = {name = emoteName, id = emoteID}
			if emoteOrder then
				customEmoteData.order = emoteOrder
			end
			table.insert(CustomEmotes, customEmoteData)
			AddEmote(emoteName, emoteID, 0)
			
			local newEmote = Emotes[#Emotes]
			newEmote.sort.newestfirst = #Emotes
			newEmote.sort.oldestfirst = 1
			newEmote.sort.alphabeticfirst = #Emotes
			newEmote.sort.alphabeticlast = 1
			newEmote.sort.lowestprice = 1
			newEmote.sort.highestprice = #Emotes
			
			if emoteOrder then
				newEmote.customOrder = emoteOrder
				CustomEmoteOrder[tostring(emoteID)] = emoteOrder
				WriteFileFunc("CustomEmoteOrder.txt", HttpService:JSONEncode(CustomEmoteOrder))
			end
			
			WriteFileFunc("CustomEmotes.txt", HttpService:JSONEncode(CustomEmotes))
			SendNotification("Emote Added", emoteName .. " has been added!")
			CustomEmoteNameBox.Text = ""
			CustomEmoteIDBox.Text = ""
			CustomEmoteOrderBox.Text = ""
			CustomEmoteFrame.Visible = false
			
			local Character = LocalPlayer.Character
			if Character then
				local Humanoid = Character:FindFirstChildOfClass("Humanoid")
				if Humanoid then
					local Description = Humanoid:FindFirstChildOfClass("HumanoidDescription")
					if Description then
						local Ratio = Instance.new("UIAspectRatioConstraint")
						Ratio.AspectType = Enum.AspectType.ScaleWithParentSize
						CreateEmoteButton(newEmote, Description, Ratio)
					end
				end
			end
		else
			SendNotification("Error", "This emote already exists!")
		end
	else
		SendNotification("Error", "Please enter a valid name and ID!")
	end
end)

function CharacterAdded(Character)
	for i, v in pairs(Frame:GetChildren()) do
		if not v:IsA("UIGridLayout") then v:Destroy() end
	end
	
	local Humanoid = WaitForChildOfClass(Character, "Humanoid")
	local Description = Humanoid:WaitForChild("HumanoidDescription", 5) or Instance.new("HumanoidDescription", Humanoid)
	
	local Ratio = Instance.new("UIAspectRatioConstraint")
	Ratio.AspectType = Enum.AspectType.ScaleWithParentSize
	
	local hideFavBtn = Instance.new("TextButton")
	hideFavBtn.Name = "HideFavoritesBtn"
	Ratio:Clone().Parent = hideFavBtn
	hideFavBtn.LayoutOrder = 0
	hideFavBtn.TextColor3 = Color3.new(1, 1, 1)
	hideFavBtn.BorderSizePixel = 0
	hideFavBtn.BackgroundTransparency = 0.3
	hideFavBtn.BackgroundColor3 = Color3.new(0, 0, 0)
	hideFavBtn.TextScaled = true
	hideFavBtn.Text = FavoritesVisible and "Hide Favorites" or "Show Favorites"
	hideFavBtn.Font = Enum.Font.GothamBold
	hideFavBtn:SetAttribute("name", "")
	Corner:Clone().Parent = hideFavBtn
	
	local HideFavStroke = Instance.new("UIStroke")
	HideFavStroke.Color = Color3.fromRGB(80, 80, 80)
	HideFavStroke.Thickness = 1
	HideFavStroke.Transparency = 0.5
	HideFavStroke.Parent = hideFavBtn
	
	hideFavBtn.MouseButton1Click:Connect(ToggleFavoriteButtons)
	hideFavBtn.MouseEnter:Connect(function()
		EmoteName.Text = "Toggle Favorites"
	end)
	hideFavBtn.Parent = Frame
	
	for i, Emote in pairs(Emotes) do
		CreateEmoteButton(Emote, Description, Ratio)
	end
	
	for i = 1, 9 do
		local EmoteButton = Instance.new("Frame")
		EmoteButton.LayoutOrder = 2147483647
		EmoteButton.Name = "filler"
		EmoteButton.BackgroundTransparency = 1
		EmoteButton.BorderSizePixel = 0
		Ratio:Clone().Parent = EmoteButton
		EmoteButton.Visible = true
		EmoteButton.Parent = Frame
	end
end

if LocalPlayer.Character then
	CharacterAdded(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(CharacterAdded)

task.wait(5)
ScreenGui.Parent = CoreGui
